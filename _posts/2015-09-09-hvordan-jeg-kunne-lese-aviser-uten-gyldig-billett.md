---
layout:     post
title:      "Hvordan jeg kunne hente ut innhold fra NSBs underholdningsapp gratis"
subtitle:   "Eller: Hvordan jeg kunne lese aviser uten gyldig billett"
date:       2015-09-09 01:46:00
author:     "Martin Ingesen"
header-img: "img/post-bg-nsb.jpg"
permalink:  "hvordan-jeg-kunne-lese-aviser-uten-gyldig-billett/"
---

**Som daglig bruker av NSBs kollektivtilbud, ble jeg tidlig nysgjerrig da NSB lanserte sin underholdningsapp. Appen tilbyr aviser og magasiner, lydbøker, musikkalbum og podcaster – til personer med gyldig billett.**

**Alt lastes enkelt ned via appen og kan brukes til å slå ihjel tid mens du sitter på toget.**

**Det var allikevel først nylig at tanken slo meg: Hvis filene lagres på en server, så er det kanskje mulig å finne ut hva url-en til filene er! Hvis jeg klarer det vil jeg ha muligheten til å laste ned .mp3er og .pdfer uten gyldig billett! Gratis aviser for alltid!**

Og det var akkurat det jeg gjorde.

##Så.. hvordan?Enkelt:Jeg emulerte en Android-telefon på datamaskinen min. På den måten ville det være mulig for meg å overvåke all trafikk som gikk til og fra Android-emulatoren via maskinen. For å gjøre denne overvåkingen enkel, benyttet jeg [Charles](http://www.charlesproxy.com/), som ga meg en rask og enkel oversikt over all trafikk som passerte.For de mer tekniske så fungerer Charles slik:- Charles oppretter en proxy- Du stiller inn emulatoren til å benytte denne proxyen.- Proxyen tilbyr et Charles CA sertifikat som du installerer på emulatoren- Med sertifikatet installert, vil Charles fungere som en man-in-the-middle og tillate oss å se all trafikk inn og ut som går over https.Nå var det bare en ting å bekymre meg for. Hvis underholdningsappen benyttet seg av [certificate pinning](https://www.owasp.org/index.php/Certificate_and_Public_Key_Pinning), ville dette bli en mye vanskeligere jobb. Hvis appen identifiserte Charles’ sertifikat, og forsto at det sertifikatet ikke er NSB sitt, kunne de blokkert all kommunikasjon via Charles, og dermed gjort hele prosessen umulig.Men det gjorde den ikke.Da jeg logget meg inn i appen i emulatoren, fikk jeg umiddelbar tilgang til alle requests og responses mellom appen og serveren til NSB, og jeg fikk plottet ut noen fine endepunkter som jeg ønsket å titte nærmere på, nemlig:    https://nsbu.nsb.no/v2/currentDownloadableNewspapers?    https://nsbu.nsb.no/v2/currentDownloadableBooks?    https://nsbu.nsb.no/v2/currentDownloadablePodcasts?    https://nsbu.nsb.no/v2/currentDownloadableAlbums?Disse endepunktene ga meg en JSON-oversikt over alle tilgjengelige aviser, bøker, podcaster og albumer. Men de fortalte meg ingenting om nøyaktig hvor filene var lokalisert. Derfor fortsatte jeg å grave litt videre, ved å faktisk prøve å laste ned en avis.Dagens Næringsliv ble tilfeldig utvalgt, og jeg lastet den ned i appen. Jeg så at Charles sendte en request til et bookDownloadLinks endepunkt, samt en filsti til en Amazon AWS-server. ``bookDownloadLinks``-endepunktet tar en token som parameter, og inneholder lenkene til alle avisene som er tilgjengelig. Det eneste problemet med dette er at du må ha en gyldig token (ergo gyldig billett) for å kunne se denne oversikten.Dermed går vi videre til lenken som fører til AWS-serveren. Denne filstien identifiserte jeg til å ha denne oppbyggingen:    https://nsb-book-hosting-prod-v2.s3.amazonaws.com/uploads/issue/pdf/$issueId/$number.pdf
hvor både ``issueID`` og ``number`` kan hentes ut fra currentDownloadableNewspapers-lenken. I noen tilfeller må man bytte ut æ, ø, å og mellomrom med understrek i ``number`` og på magisk vis hadde jeg fri tilgang til de nyeste opplagene av:
- Bergens Tidende
- Adresseavisen
- Stavanger Aftenblad
- Fædrelandsvennen
- Dagens Næringsliv
- Aftenposten
- A-magasinet
- Morgenbladet
- D2Det samme gjaldt også lydbøker og album, som hadde denne oppbyggingen
    https://nsb-book-hosting-prod-v2.s3.amazonaws.com/uploads/chapter/mp3/$chapterId/$name.mp3
    https://nsb-book-hosting-prod-v2.s3.amazonaws.com/uploads/track/mp3/$trackId/$artist_-_$name.mp3hvorav all nødvendig informasjon ligger i currentDownloadableBooks/Albums.Det viste seg å være litt verre med podcasts. Jeg nevnte tidligere at appen sender en request til et bookDownloadLinks-endepunkt når den skal laste ned aviser, det samme gjelder alle de andre også. I tilfellet til podcastene var det ikke like lett å gjette seg til hvordan URL'en skulle se ut, fordi informasjonen i currentDownloadblePodcasts ikke var tilstrekkelig. Det var heller ikke mulig å hente denne informasjonen direkte via \*downloadLinks-endepunktet, fordi den krevde en gyldig token.Men allikevel, tre av fire er ikke så dårlig!#Så, hvordan fikser du sikkerhetshullet?Den raskeste og enkleste måten å fikse problemet på er ved å:.1. Gjør filnavn og lokasjon tilfeldigVed å gjøre filnavnet tilfeldig (eventuelt deler av filnavnet), vil du være helt nødt til å hente nedlastingslenken fra \*downloadLinks-endepunktet. Dette endepunktet krever en gyldig token, som kun gjør endepunktet tilgjengelig til brukere som faktisk har kjøpt billett hos NSB..2. Certificate pinningVed å hardkode et sertifikat i applikasjonen, kan NSB beskytte seg mot man-in-the-middle-angrep ved å kun tillate kommunikasjon med det hardkodede sertifikatet. På denne måten blir det mye vanskeligere å få innblikk i hvordan applikasjonen fungerer internt og hvordan den samhandler med det bakenforliggende APIet.
Det går også rykter om at Google og Apple skal begynne å kreve at utviklere benytter seg av certificate pinning i appene sine.
Dette er ikke skuddsikkert, da hackere i teorien kan prøve å bytte ut sertifikatet med et annet, slik at de kan fortsette å være mannen i midten, men dette er en så stor og krevende oppgave at de færreste er interessert i å prøve. Eventuelt kan de patche telefonens håndtering av SSL, [https://github.com/iSECPartners/ios-ssl-kill-switch](slik iOS SSL Kill Switch) gjør.###Tidslinje- Lørdag 5 September 2015: Proof-of-concept- Mandag 7 September 2015: Kontakt med appansvarlig i NSB- Mandag 7 September 2015: Informasjon videreformidlet til person ansvarlig for underholdningsappen.- Tirsdag 15 September 2015: Tilbakemelding om at feilen vil bli fikset.###Tusen takk tilNSB, som var veldig imøtekommende med min rapport, og som oppførte seg meget profesjonelt ovenfor meg.[Per Torsheim](https://godpraksis.no/about/), som ga meg råd og veiledning rundt det å utføre en responsible disclosure, og for at han brukte sitt store kontaktnettverk til å sette meg i kontakt med de riktige personene i NSB.[Stine Friis](http://stinefriis.com/) som er så behjelpelig med å lese over det jeg skriver og peker ut skriveleifer og rare setningsoppbygginger!Headerbilde fra <a href="https://www.flickr.com/photos/nsb_no/6100728153/in/album-72157627564580720/">NSB og Leif J. Olestad</a><hr>###Trenger du eller ditt firma informasjon om sikring av apper og/eller APIer?####Ta gjerne kontakt for en pratMartin Ingesen<br>martin@ingesen.no<br>+47 99125088